# Usage Examples:
#   docker compose up -d                         # Start nothing (all services require profiles)
#   docker compose --profile dapr up -d          # Start infrastructure + Dapr services
#   docker compose --profile infra --profile dapr --profile embeddings up -d  # Start multiple profiles

x-daprdimage: &daprdimage
  image: daprio/daprd:1.16.0
  volumes:
    - ./dapr/components/:/components
    - ./dapr/configuration/:/configuration

services:
  ##############################################
  #                    Dapr                    #
  ##############################################

  dapr-placement:
    profiles: ["deps","dapr"]
    image: daprio/dapr:1.16.0
    container_name: cossessor-dapr-placement
    command: ["./placement", "-port", "50006"]
    ports:
      - 50006:50006
    networks:
      - cossessor-network

  dapr-scheduler:
    profiles: ["deps","dapr"]
    image: daprio/dapr:1.16.0
    container_name: cossessor-dapr-scheduler
    user: root
    command: ["./scheduler", "--etcd-data-dir", "/tmp/scheduler-data"]
    ports:
      - 50007:50006
    volumes:
      - dapr-scheduler-data:/data
    networks:
      - cosessor-network

  ##############################################
  #                   MongoDB                  #
  ##############################################
  mongo:
    profiles: ['infra', 'dapr']
    image: mongo:7
    container_name: mongo-cossessor
    platform: 'linux/arm64'
    command: [--replSet, rs0, --bind_ip_all, --port, "27017"]
    ports:
      - 27017:27017
    healthcheck:
      test: test $$(mongosh --port 27017 --quiet --eval "try {rs.initiate({_id:'rs0',members:[{_id:0,host:\"mongo:27017\"}]})} catch(e) {rs.status().ok}") -eq 1
      interval: 10s
      start_period: 30s
    volumes:
      - mongodb-data:/data/keyfile
    networks:
      - cosessor-network

  mongo-express:
    profiles: ['infra', 'dapr']
    image: mongo-express:latest
    container_name: mongo-express-cossessor
    ports:
      - "8081:8081"
    environment:
      ME_CONFIG_MONGODB_SERVER: mongo-cossessor
    depends_on:
      mongo:
        condition: service_healthy
    networks:
      - cosessor-network

  ##############################################
  #                   ChromaDB                 #
  ##############################################
  chromadb:
    profiles: ['infra', 'chroma']
    image: chromadb/chroma:0.5.16
    container_name: chromadb-cossessor
    platform: 'linux/arm64'
    ports:
      - 8000:8000
    command: "--workers 1 --host 0.0.0.0 --port 8000 --proxy-headers --log-config chromadb/log_config.yml --timeout-keep-alive 30"
    environment:
      - ALLOW_RESET=True
      - IS_PERSISTENT=True
      - CHROMA_SERVER_AUTHN_CREDENTIALS_FILE=/chroma/server.htpasswd
      - CHROMA_SERVER_AUTHN_PROVIDER=chromadb.auth.basic_authn.BasicAuthenticationServerProvider
    volumes:
      - chroma-data:/chroma/chroma
      - ./chromadb/server.htpasswd:/chroma/server.htpasswd
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/api/v1/heartbeat || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - cosessor-network

  ###################################################
  #                EMBEDDINGS API                   #
  ###################################################
  cossessor-embeddings-api:
    profiles: ['embeddings']
    image: cossessor/embeddings-api:dev
    platform: 'linux/arm64'
    build:
      context: ./embeddings-api/
      dockerfile: Dockerfile
      tags:
        - cossessor/embeddings-api:dev
    ports:
      - 6002:8001
    environment:
      - DEBUGGING=False
      - PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION=python
    depends_on:
      chromadb:
        condition: service_healthy
    volumes:
      - ./embeddings-api/src/.docker-compose.env:/app/.env
    networks:
      - cosessor-network

  cossessor-embeddings-api-dapr:
    profiles: ['embeddings']
    <<: *daprdimage
    command: [
      "./daprd",
      "--app-id", "cossessor-embeddings-api",
      "-app-protocol", "http",
      "-app-channel-address", "cossessor-embeddings-api",
      "--placement-host-address", "dapr-placement:50006",
      "--app-port", "8001",
      "-dapr-http-port", "3501",
      "-dapr-grpc-port", "50001",
      "--resources-path", "/components",
      "--config", "/configuration/config.yaml" 
    ]
    depends_on:
      - cossessor-embeddings-api
    network_mode: service:cossessor-embeddings-api
    networks:
      - cosessor-network
  
  ###################################################
  #            EMBEDDINGS MCP SERVER                #
  ###################################################
  embeddings-mcp:
    profiles: ['embeddings']
    build:
      context: ./embeddings-mcp
      dockerfile: Dockerfile
    container_name: embeddings-mcp
    ports:
      - "8912:8912"
    environment:
      - PORT=8912
      - LOG_LEVEL=info
      - EMBEDDINGS_API_HOST=cossessor-embeddings-api
      - EMBEDDINGS_API_PORT=8001
      - EMBEDDINGS_API_TIMEOUT=60000
    depends_on:
      cossessor-embeddings-api:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8912/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    networks:
      - cosessor-network

networks:
  cosessor-network:
    driver: bridge

volumes:
  pgdata: {}
  node_modules: {}
  mongodb-data:
  chroma-data:
    driver: local
